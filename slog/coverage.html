
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>slog: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">github.com/wasilak/otelgo/slog/slog.go (70.7%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package slog

import (
        "context"
        "fmt"

        "log/slog"

        "go.opentelemetry.io/otel/codes"
        otellog "go.opentelemetry.io/otel/log"
        sdktrace "go.opentelemetry.io/otel/sdk/trace"
        "go.opentelemetry.io/otel/trace"
)

// TracingHandler wraps a slog.Handler to add OpenTelemetry tracing information to log records.
// It enriches log entries with trace context, span details, and other OpenTelemetry attributes.
type TracingHandler struct {
        handler slog.Handler
}

const sevOffset = slog.Level(otellog.SeverityDebug) - slog.LevelDebug

// NewTracingHandler creates a new TracingHandler that wraps the provided slog.Handler.
// If the provided handler is already a TracingHandler, it returns the underlying handler
// to avoid multiple layers of wrapping.
//
// Parameters:
//   - h: The slog.Handler to wrap
//
// Returns:
//   - *TracingHandler: A new handler that adds tracing information to log records
func NewTracingHandler(h slog.Handler) *TracingHandler <span class="cov8" title="1">{
        // avoid chains of handlers.
        if lh, ok := h.(*TracingHandler); ok </span><span class="cov8" title="1">{
                h = lh.Handler()
        }</span>
        <span class="cov8" title="1">return &amp;TracingHandler{h}</span>
}

// Handler returns the underlying slog.Handler wrapped by this TracingHandler.
// This method is useful when you need to access or modify the base handler.
//
// Returns:
//   - slog.Handler: The underlying handler
func (h *TracingHandler) Handler() slog.Handler <span class="cov8" title="1">{
        return h.handler
}</span>

// Enabled reports whether the handler handles records at the given level.
// The check is delegated to the underlying handler.
//
// Parameters:
//   - ctx: The context containing the current span
//   - level: The log level to check
//
// Returns:
//   - bool: true if the handler processes records at the given level
func (h *TracingHandler) Enabled(ctx context.Context, level slog.Level) bool <span class="cov8" title="1">{
        return h.handler.Enabled(ctx, level)
}</span>

// Handle processes the log record by adding OpenTelemetry trace context and span information.
// If there is an active span, it adds trace ID, span ID, and other span attributes to the record.
// For error level logs, it also sets the span status to error.
//
// Parameters:
//   - ctx: The context containing the current span
//   - r: The log record to process
//
// Returns:
//   - error: Non-nil if handling the record fails
func (h *TracingHandler) Handle(ctx context.Context, r slog.Record) error <span class="cov8" title="1">{
        span := trace.SpanFromContext(ctx)

        if span.IsRecording() </span><span class="cov8" title="1">{
                if r.Level &gt;= slog.LevelError </span><span class="cov8" title="1">{
                        span.SetStatus(codes.Error, r.Message)
                }</span>

                <span class="cov8" title="1">r = alignWithOTELSpecs(r, span)</span>
        }

        <span class="cov8" title="1">return h.handler.Handle(ctx, r)</span>
}

// WithAttrs returns a new TracingHandler whose handler includes the given attributes.
//
// Parameters:
//   - attrs: The attributes to add to all records
//
// Returns:
//   - slog.Handler: A new handler with the additional attributes
func (h *TracingHandler) WithAttrs(attrs []slog.Attr) slog.Handler <span class="cov8" title="1">{
        return NewTracingHandler(h.handler.WithAttrs(attrs))
}</span>

// WithGroup returns a new TracingHandler whose handler includes the given group.
//
// Parameters:
//   - name: The name of the group
//
// Returns:
//   - slog.Handler: A new handler with the additional group
func (h *TracingHandler) WithGroup(name string) slog.Handler <span class="cov8" title="1">{
        return NewTracingHandler(h.handler.WithGroup(name))
}</span>

// https://opentelemetry.io/docs/specs/otel/logs/data-model/#log-and-event-record-definition
// Timestamp        Time when the event occurred.
// ObservedTimestamp        Time when the event was observed.
// TraceId        Request trace id.
// SpanId        Request span id.
// TraceFlags        W3C trace flag.
// SeverityText        The severity text (also known as log level).
// SeverityNumber        Numerical value of the severity.
// Body        The body of the log record.
// Resource        Describes the source of the log.
// InstrumentationScope        Describes the scope that emitted the log.
// Attributes        Additional information about the event.
func alignWithOTELSpecs(r slog.Record, span trace.Span) slog.Record <span class="cov8" title="1">{
        traceId := ""
        spanId := ""
        traceFlags := ""
        if spanCtx := span.SpanContext(); spanCtx.HasTraceID() </span><span class="cov8" title="1">{
                spanId = spanCtx.SpanID().String()
                traceId = spanCtx.TraceID().String()
                traceFlags = spanCtx.TraceFlags().String()
        }</span>
        <span class="cov8" title="1">r.AddAttrs(slog.String("TraceId", traceId))
        r.AddAttrs(slog.String("SpanId", spanId))
        r.AddAttrs(slog.String("TraceFlags", traceFlags))

        // Convert the span to ReadOnlySpan to access attributes
        roSpan, ok := span.(sdktrace.ReadOnlySpan)
        if !ok </span><span class="cov8" title="1">{
                fmt.Println("Span is not a ReadOnlySpan")
        }</span> else<span class="cov0" title="0"> {
                // Create a group for span attributes
                attributes := make([]any, 0) // Use []any for slog.Group compatibility
                for _, attr := range roSpan.Attributes() </span><span class="cov0" title="0">{
                        attributes = append(attributes, slog.String(string(attr.Key), attr.Value.Emit()))
                }</span>
                <span class="cov0" title="0">r.AddAttrs(slog.Group("Attributes", attributes...))

                // Add InstrumentationScope details as a group
                scope := roSpan.InstrumentationScope()
                scopeAttrs := make([]any, 0) // Use []any for slog.Group compatibility
                iter := scope.Attributes.Iter()
                for iter.Next() </span><span class="cov0" title="0">{
                        attr := iter.Attribute()
                        scopeAttrs = append(scopeAttrs, slog.String(string(attr.Key), attr.Value.Emit()))
                }</span>
                <span class="cov0" title="0">r.AddAttrs(slog.Group("InstrumentationScope",
                        slog.String("Name", scope.Name),
                        slog.String("Version", scope.Version),
                        slog.Group("Attributes", scopeAttrs...),
                ))

                // Add other span details
                r.AddAttrs(
                        slog.String("SpanName", roSpan.Name()),
                        slog.String("SpanKind", roSpan.SpanKind().String()),
                        slog.String("Resource", roSpan.Resource().String()),
                        slog.String("Timestamp", roSpan.StartTime().String()),
                        slog.String("ObservedTimestamp", roSpan.StartTime().String()),
                )</span>
        }

        <span class="cov8" title="1">sev := slog.Level(int(r.Level)) + sevOffset

        // Add severity and message details
        r.AddAttrs(
                slog.String("SeverityText", r.Level.String()),
                slog.Int("SeverityNumber", int(sev)),
                slog.String("Body", r.Message),
        )

        return r</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
